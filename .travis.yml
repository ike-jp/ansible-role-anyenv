---
# User Ubuntu14.04 Server LTS
sudo: required
dist: trusty

language: python
python: "2.7"

env:
  - SITE=test.yml

before_install:
  - sudo add-apt-repository -y "deb http://archive.ubuntu.com/ubuntu/ trusty main universe"
  - sudo apt-get update -qq

install:
  # Install Ansible.
  - pip install ansible==1.9.4

  # Add ansible.cfg to pick up roles path.
  - "{ echo '[defaults]'; echo 'roles_path = ../'; echo 'executable = /bin/bash'; } >> ansible.cfg"

  # Install dependencies.
  - ansible-galaxy install yaegashi.blockinfile

script:
  # Change loaded profile
  #- rm ~/.bash_profile
  #- source ~/.profile

  # [debug] Show ansible
  - ansible --version

  # [debug] Show current directory
  - pwd
  - ls -lah
  - cat ansible.cfg

  - readlink -f ~
  - readlink -f $HOME

  # [debug] Show login shell
  - echo $SHELL
  - cat /etc/shells
  - ls -la /bin/bash

  # [debug] Show home directory
  - ls -lah ~
  - cat ~/.profile
  - cat ~/.bashrc

  # Check the role/playbook's syntax.
  - "ansible-playbook -i tests/inventory tests/$SITE --syntax-check"

  # Run the role/playbook with ansible-playbook.
  - "ansible-playbook -i tests/inventory tests/$SITE --connection=local -vvvv"

  # [debug] Show after home directory
  - ls -lah ~
  - cat ~/.profile
  - cat ~/.bashrc

  # [debug] Show anyenv version
  - anyenv version
  - source ~/.bashrc
  - anyenv version

  # Run the role/playbook again, checking to make sure it's idempotent.
  - >
    ansible-playbook -i tests/inventory tests/$SITE --connection=local --sudo
    | grep -q 'changed=0.*failed=0'
    && (echo 'Idempotence test: pass' && exit 0)
    || (echo 'Idempotence test: fail' && exit 1)
  # Check if anyenv is reachable.
  - anyenv version:
